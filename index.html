// ====================================
// MGTOKYO品川 メンテナンス管理システム
// ====================================

// 設定
const CONFIG = {
  // カレンダーID
  CUSTOMER_CALENDAR_ID: 'khjrlhs0ib100i37t3nglg1n9g@group.calendar.google.com',
  MAINTENANCE_CALENDAR_ID: 'f15a88b8e57c199598589f28bd7c0619a902d65850b6987bbec707bccfb0bdf0@group.calendar.google.com',
  
  // タイムゾーン
  TIMEZONE: 'Asia/Tokyo'
};

// ====================================
// Web APIエンドポイント
// ====================================

function doGet(e) {
  const action = e.parameter.action;
  const date = e.parameter.date; // 'today' or 'tomorrow'
  
  try {
    switch(action) {
      case 'getSchedule':
        return createJsonResponse(getSchedule(date));
        
      default:
        return createJsonResponse({ error: 'Invalid action' }, 400);
    }
  } catch (error) {
    Logger.log('Error in doGet: ' + error.toString());
    return createJsonResponse({ error: error.toString() }, 500);
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    switch(action) {
      case 'createMaintenance':
        const result = createMaintenance(data.date, data.startTime, data.endTime, data.cleanerName);
        return createJsonResponse(result);
        
      case 'completeMaintenance':
        const completeResult = completeMaintenance(data.eventId);
        return createJsonResponse(completeResult);
        
      case 'cancelMaintenance':
        const cancelResult = cancelMaintenance(data.eventId);
        return createJsonResponse(cancelResult);
        
      default:
        return createJsonResponse({ error: 'Invalid action' }, 400);
    }
  } catch (error) {
    Logger.log('Error in doPost: ' + error.toString());
    return createJsonResponse({ error: error.toString() }, 500);
  }
}

// ====================================
// スケジュール取得
// ====================================

function getSchedule(dateType) {
  const targetDate = getTargetDate(dateType);
  const dayStart = new Date(targetDate);
  dayStart.setHours(0, 0, 0, 0);
  
  const dayEnd = new Date(targetDate);
  dayEnd.setHours(23, 59, 59, 999);
  
  // お客様予約を取得
  const customerCalendar = CalendarApp.getCalendarById(CONFIG.CUSTOMER_CALENDAR_ID);
  const customerEvents = customerCalendar.getEvents(dayStart, dayEnd);
  
  // メンテナンス予約を取得
  const maintenanceCalendar = CalendarApp.getCalendarById(CONFIG.MAINTENANCE_CALENDAR_ID);
  const maintenanceEvents = maintenanceCalendar.getEvents(dayStart, dayEnd);
  
  const schedule = [];
  
  // お客様予約を追加
  customerEvents.forEach(function(event) {
    schedule.push({
      id: event.getId(),
      type: 'customer',
      startTime: formatTime(event.getStartTime()),
      endTime: formatTime(event.getEndTime()),
      title: event.getTitle()
    });
  });
  
  // メンテナンス予約を追加
  maintenanceEvents.forEach(function(event) {
    const description = event.getDescription() || '';
    const status = description.includes('完了') ? 'completed' : 'scheduled';
    
    schedule.push({
      id: event.getId(),
      type: 'cleaning',
      startTime: formatTime(event.getStartTime()),
      endTime: formatTime(event.getEndTime()),
      status: status,
      cleanerName: extractCleanerName(description),
      notes: extractNotes(description)
    });
  });
  
  // 時刻順にソート
  schedule.sort(function(a, b) {
    return a.startTime.localeCompare(b.startTime);
  });
  
  return {
    success: true,
    date: formatDate(targetDate),
    schedule: schedule
  };
}

// ====================================
// メンテナンス予約作成
// ====================================

function createMaintenance(dateType, startTime, endTime, cleanerName) {
  const targetDate = getTargetDate(dateType);
  
  // 日付と時刻を結合
  const startDateTime = parseDateTime(targetDate, startTime);
  const endDateTime = parseDateTime(targetDate, endTime);
  
  // 重複チェック
  const conflict = checkTimeConflict(startDateTime, endDateTime);
  if (conflict) {
    return {
      success: false,
      error: conflict.message
    };
  }
  
  // メンテナンスカレンダーに予約を作成
  const maintenanceCalendar = CalendarApp.getCalendarById(CONFIG.MAINTENANCE_CALENDAR_ID);
  
  const event = maintenanceCalendar.createEvent(
    'メンテナンス',
    startDateTime,
    endDateTime,
    {
      description: 'ステータス: 予約済み\n担当者: ' + (cleanerName || '未設定'),
      colorId: CalendarApp.EventColor.PURPLE
    }
  );
  
  Logger.log('メンテナンス予約作成: ' + event.getId());
  
  return {
    success: true,
    eventId: event.getId(),
    message: 'メンテナンス予約を作成しました'
  };
}

// ====================================
// 時間重複チェック
// ====================================

function checkTimeConflict(startDateTime, endDateTime) {
  // お客様予約との重複チェック
  const customerCalendar = CalendarApp.getCalendarById(CONFIG.CUSTOMER_CALENDAR_ID);
  const customerEvents = customerCalendar.getEvents(startDateTime, endDateTime);
  
  if (customerEvents.length > 0) {
    const conflictEvent = customerEvents[0];
    return {
      message: 'お客様予約と重複しています（' + 
               formatTime(conflictEvent.getStartTime()) + '-' + 
               formatTime(conflictEvent.getEndTime()) + '）'
    };
  }
  
  // 既存のメンテナンス予約との重複チェック
  const maintenanceCalendar = CalendarApp.getCalendarById(CONFIG.MAINTENANCE_CALENDAR_ID);
  const maintenanceEvents = maintenanceCalendar.getEvents(startDateTime, endDateTime);
  
  if (maintenanceEvents.length > 0) {
    const conflictEvent = maintenanceEvents[0];
    return {
      message: 'すでにメンテナンス予約が入っています（' + 
               formatTime(conflictEvent.getStartTime()) + '-' + 
               formatTime(conflictEvent.getEndTime()) + '）'
    };
  }
  
  return null;
}

// ====================================
// メンテナンス完了記録
// ====================================

function completeMaintenance(eventId) {
  const maintenanceCalendar = CalendarApp.getCalendarById(CONFIG.MAINTENANCE_CALENDAR_ID);
  const event = maintenanceCalendar.getEventById(eventId);
  
  if (!event) {
    throw new Error('イベントが見つかりません');
  }
  
  // 現在の説明文を取得して担当者を保持
  const currentDescription = event.getDescription() || '';
  const cleanerName = extractCleanerName(currentDescription);
  
  // 説明文を更新
  const now = new Date();
  const description = 'ステータス: 完了\n完了時刻: ' + formatDateTime(now) + '\n担当者: ' + cleanerName;
  
  event.setDescription(description);
  event.setColor(CalendarApp.EventColor.GREEN);
  event.setTitle('メンテナンス完了');
  
  Logger.log('メンテナンス完了記録: ' + eventId);
  
  return {
    success: true,
    message: 'メンテナンス完了を記録しました'
  };
}

// ====================================
// メンテナンス予約キャンセル
// ====================================

function cancelMaintenance(eventId) {
  const maintenanceCalendar = CalendarApp.getCalendarById(CONFIG.MAINTENANCE_CALENDAR_ID);
  const event = maintenanceCalendar.getEventById(eventId);
  
  if (!event) {
    throw new Error('イベントが見つかりません');
  }
  
  event.deleteEvent();
  
  Logger.log('メンテナンス予約キャンセル: ' + eventId);
  
  return {
    success: true,
    message: 'メンテナンス予約をキャンセルしました'
  };
}

// ====================================
// ユーティリティ関数
// ====================================

function getTargetDate(dateType) {
  const now = new Date();
  
  if (dateType === 'tomorrow') {
    now.setDate(now.getDate() + 1);
  }
  
  return now;
}

function parseDateTime(date, timeString) {
  const timeParts = timeString.split(':');
  const hours = parseInt(timeParts[0]);
  const minutes = parseInt(timeParts[1]);
  const result = new Date(date);
  result.setHours(hours, minutes, 0, 0);
  return result;
}

function formatTime(date) {
  return Utilities.formatDate(date, CONFIG.TIMEZONE, 'HH:mm');
}

function formatDate(date) {
  return Utilities.formatDate(date, CONFIG.TIMEZONE, 'yyyy年MM月dd日（E）');
}

function formatDateTime(date) {
  return Utilities.formatDate(date, CONFIG.TIMEZONE, 'yyyy年MM月dd日 HH:mm');
}

function extractCleanerName(description) {
  const match = description.match(/担当者?:\s*(.+?)(?:\n|$)/);
  return match ? match[1].trim() : '未設定';
}

function extractNotes(description) {
  const match = description.match(/備考:\s*(.+)/);
  return match ? match[1].trim() : '';
}

function createJsonResponse(data, statusCode) {
  const output = ContentService.createTextOutput(JSON.stringify(data));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

// ====================================
// テスト用関数
// ====================================

function testGetSchedule() {
  const result = getSchedule('today');
  Logger.log(JSON.stringify(result, null, 2));
}

function testCreateMaintenance() {
  const result = createMaintenance('today', '14:00', '15:00', '希望泉');
  Logger.log(JSON.stringify(result, null, 2));
}

function testCompleteMaintenance() {
  // 実際のイベントIDに置き換えてテスト
  const eventId = 'your_event_id_here';
  const result = completeMaintenance(eventId);
  Logger.log(JSON.stringify(result, null, 2));
}
