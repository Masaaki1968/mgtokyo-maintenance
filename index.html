<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#16a34a">
    <title>メンテナンス時間管理 - MGTOKYO品川</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">読み込み中...</p>
            </div>
        </div>
    </div>
    
    <script>
        // ========================================
        // 設定
        // ========================================
        const CONFIG = {
            GAS_API_URL: 'https://script.google.com/macros/s/AKfycbyEWm7vORtbq7MqUdb-DFITvfT_lxwaaH9n_g7li1Exdx7IqSsNjQEZdTtQ-v11pJKm/exec',
            USERS: [
                { username: 'kibousen', password: 'kibousen2024', name: 'takako-san' },
                { username: 'staff2', password: 'staff2024', name: 'スタッフ2' },
                { username: 'admin', password: 'mgtokyo2024', name: '管理者' }
            ]
        };
        
        // グローバル変数
        let currentUser = null;
        let currentDate = 'today';
        let scheduleData = [];
        let selectedBookingDate = 'today';
        let cleaningHistory = [];
        
        // ========================================
        // 初期化
        // ========================================
        function init() {
            console.log('アプリ初期化開始...');
            checkLogin();
        }
        
        // ========================================
        // ログイン確認
        // ========================================
        function checkLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                console.log('ログイン済み:', currentUser.name);
                renderApp();
                loadSchedule('today');
            } else {
                console.log('未ログイン - ログイン画面を表示');
                renderLoginScreen();
            }
        }
        
        // ========================================
        // ログイン画面
        // ========================================
        function renderLoginScreen() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-green-50 to-green-100">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div class="bg-gradient-to-r from-green-600 to-green-700 text-white p-8 text-center">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                            </svg>
                            <h1 class="text-2xl font-bold">メンテナンス時間管理</h1>
                            <p class="text-green-100 text-sm mt-2">MGTOKYO品川</p>
                        </div>
                        
                        <div class="p-8">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">ログイン</h2>
                            
                            <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">
                            </div>
                            
                            <form onsubmit="handleLogin(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">ユーザー名</label>
                                    <input 
                                        type="text" 
                                        id="username" 
                                        required
                                        autocomplete="username"
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none text-base"
                                        placeholder="ユーザー名を入力"
                                    >
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">パスワード</label>
                                    <input 
                                        type="password" 
                                        id="password" 
                                        required
                                        autocomplete="current-password"
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none text-base"
                                        placeholder="パスワードを入力"
                                    >
                                </div>
                                
                                <button 
                                    type="submit" 
                                    class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-xl font-bold hover:from-green-700 hover:to-green-800 transition-all shadow-lg hover:shadow-xl"
                                >
                                    ログイン
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ========================================
        // ログイン処理
        // ========================================
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            const user = CONFIG.USERS.find(function(u) {
                return u.username === username && u.password === password;
            });
            
            if (user) {
                currentUser = { username: user.username, name: user.name };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log('ログイン成功:', currentUser.name);
                renderApp();
                loadSchedule('today');
            } else {
                const errorDiv = document.getElementById('login-error');
                errorDiv.textContent = 'ユーザー名またはパスワードが正しくありません';
                errorDiv.className = 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm';
            }
        }
        
        // ========================================
        // ログアウト
        // ========================================
        function handleLogout() {
            if (confirm('ログアウトしますか？')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                renderLoginScreen();
            }
        }
        
        // ========================================
        // スケジュール読み込み
        // ========================================
        async function loadSchedule(dateType) {
            try {
                showLoading();
                currentDate = dateType;
                
                console.log('スケジュール取得開始:', dateType);
                const response = await fetch(CONFIG.GAS_API_URL + '?action=getSchedule&date=' + dateType);
                const data = await response.json();
                console.log('スケジュール取得完了:', data);
                
                if (data.success) {
                    scheduleData = data.schedule;
                    renderSchedule(data.schedule, data.date, dateType);
                } else {
                    throw new Error('スケジュールの取得に失敗しました');
                }
            } catch (error) {
                console.error('スケジュール取得エラー:', error);
                showError('スケジュールの取得に失敗しました: ' + error.message);
            }
        }
        
        // ========================================
        // 清掃履歴読み込み
        // ========================================
        async function loadCleaningHistory(days) {
            try {
                showLoading();
                
                console.log('清掃履歴取得開始:', days + '日分');
                const response = await fetch(CONFIG.GAS_API_URL + '?action=getCleaningHistory&days=' + days);
                const data = await response.json();
                console.log('清掃履歴取得完了:', data);
                
                if (data.success) {
                    cleaningHistory = data.history;
                    renderCleaningHistory(data.history);
                } else {
                    throw new Error('清掃履歴の取得に失敗しました');
                }
            } catch (error) {
                console.error('清掃履歴取得エラー:', error);
                showError('清掃履歴の取得に失敗しました: ' + error.message);
            }
        }
        
        // ========================================
        // メンテナンス予約作成
        // ========================================
        async function createMaintenance(dateType, startTime, endTime) {
            try {
                showLoading();
                
                console.log('メンテナンス予約作成:', { dateType, startTime, endTime, user: currentUser.name });
                const response = await fetch(CONFIG.GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'createMaintenance',
                        date: dateType,
                        startTime: startTime,
                        endTime: endTime,
                        cleanerName: currentUser.name
                    })
                });
                
                const data = await response.json();
                console.log('予約作成完了:', data);
                
                if (data.success) {
                    alert('メンテナンス予約を作成しました');
                    await loadSchedule(currentDate);
                    closeModal();
                } else {
                    throw new Error(data.error || '予約の作成に失敗しました');
                }
            } catch (error) {
                console.error('予約作成エラー:', error);
                showError('予約の作成に失敗しました: ' + error.message);
            }
        }
        
        // ========================================
        // メンテナンスキャンセル
        // ========================================
        async function cancelMaintenance(eventId) {
            try {
                showLoading();
                
                console.log('メンテナンスキャンセル:', eventId);
                const response = await fetch(CONFIG.GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'cancelMaintenance',
                        eventId: eventId
                    })
                });
                
                const data = await response.json();
                console.log('キャンセル完了:', data);
                
                if (data.success) {
                    alert('メンテナンス予約をキャンセルしました');
                    await loadSchedule(currentDate);
                    closeModal();
                } else {
                    throw new Error(data.error || 'キャンセルに失敗しました');
                }
            } catch (error) {
                console.error('キャンセルエラー:', error);
                showError('キャンセルに失敗しました: ' + error.message);
            }
        }
        
        // ========================================
        // UI描画
        // ========================================
        function renderApp() {
            const currentTime = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('app').innerHTML = `
                <div class="max-w-md mx-auto min-h-screen pb-20">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-green-600 to-green-700 text-white p-5 shadow-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h1 class="text-2xl font-bold">メンテナンス時間管理</h1>
                                <p class="text-sm text-green-100 mt-1">MGTOKYO品川</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-3 backdrop-blur-sm">
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    <span class="font-medium">${currentUser.name}</span>
                                </div>
                                <button onclick="handleLogout()" class="text-xs bg-white bg-opacity-20 px-3 py-1 rounded-full hover:bg-opacity-30 transition-all">
                                    ログアウト
                                </button>
                            </div>
                            <div class="flex items-center justify-between text-sm mt-2 pt-2 border-t border-white border-opacity-20">
                                <span>現在時刻</span>
                                <span class="text-lg font-bold">${currentTime}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex bg-white shadow-sm border-b" id="date-tabs"></div>

                    <!-- Content -->
                    <div class="p-4" id="content-area">
                        <div class="text-center py-8">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-gray-600">読み込み中...</p>
                        </div>
                    </div>

                    <!-- 追加ボタン -->
                    <div class="fixed bottom-8 right-8 z-40">
                        <button onclick="openBookingModal()" class="bg-gradient-to-r from-green-600 to-green-700 text-white w-20 h-20 rounded-full shadow-2xl hover:shadow-3xl transition-all flex items-center justify-center hover:scale-110 border-4 border-white">
                            <span class="text-4xl font-bold leading-none">+</span>
                        </button>
                    </div>

                    <!-- Modal -->
                    <div id="modal" class="hidden"></div>
                </div>
            `;
        }
        
        function renderSchedule(schedule, dateText, dateType) {
            const tabs = `
                <button onclick="switchTab('today')" class="flex-1 py-3 text-center font-bold transition-all relative ${dateType === 'today' ? 'text-green-600' : 'text-gray-400'}">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="text-sm">${getTodayText()}</span>
                    </div>
                    ${dateType === 'today' ? '<div class="absolute bottom-0 left-0 right-0 h-1 bg-green-600 rounded-t"></div>' : ''}
                </button>
                <button onclick="switchTab('tomorrow')" class="flex-1 py-3 text-center font-bold transition-all relative ${dateType === 'tomorrow' ? 'text-green-600' : 'text-gray-400'}">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="text-sm">${getTomorrowText()}</span>
                    </div>
                    ${dateType === 'tomorrow' ? '<div class="absolute bottom-0 left-0 right-0 h-1 bg-green-600 rounded-t"></div>' : ''}
                </button>
                <button onclick="switchTab('history')" class="flex-1 py-3 text-center font-bold transition-all relative ${dateType === 'history' ? 'text-green-600' : 'text-gray-400'}">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-sm">履歴</span>
                    </div>
                    ${dateType === 'history' ? '<div class="absolute bottom-0 left-0 right-0 h-1 bg-green-600 rounded-t"></div>' : ''}
                </button>
            `;
            
            document.getElementById('date-tabs').innerHTML = tabs;
            
            let html = '<div class="space-y-2">';
            
            if (schedule.length === 0) {
                html += `
                    <div class="text-center py-16">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p class="text-gray-400 font-medium">予定はありません</p>
                    </div>
                `;
            } else {
                schedule.forEach(function(slot) {
                    const duration = calculateDuration(slot.startTime, slot.endTime);
                    
                    if (slot.type === 'customer') {
                        html += `
                            <div class="bg-blue-100 border-2 border-blue-300 rounded-lg p-4 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-5 h-5 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                        </svg>
                                        <span class="font-bold text-blue-900">お客様予約</span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 text-blue-800">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="font-bold">${slot.startTime} - ${slot.endTime}</span>
                                    <span class="text-sm">(${duration}分)</span>
                                </div>
                            </div>
                        `;
                    } else if (slot.type === 'cleaning') {
                        html += `
                            <div onclick="openMaintenanceDetail('${slot.id}')" class="bg-purple-100 border-2 border-purple-300 rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md transition-all">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-5 h-5 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                                        </svg>
                                        <span class="font-bold text-purple-900">メンテナンス予約</span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 mb-2 text-purple-800">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="font-bold">${slot.startTime} - ${slot.endTime}</span>
                                    <span class="text-sm">(${duration}分)</span>
                                </div>
                                <div class="text-xs text-gray-600">
                                    担当: ${slot.cleanerName || '未設定'}
                                    ${slot.notes ? ' / ' + slot.notes : ''}
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            html += '</div>';
            document.getElementById('content-area').innerHTML = html;
        }
        
        function renderCleaningHistory(history) {
            const tabs = `
                <button onclick="switchTab('today')" class="flex-1 py-3 text-center font-bold transition-all relative text-gray-400">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="text-sm">${getTodayText()}</span>
                    </div>
                </button>
                <button onclick="switchTab('tomorrow')" class="flex-1 py-3 text-center font-bold transition-all relative text-gray-400">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="text-sm">${getTomorrowText()}</span>
                    </div>
                </button>
                <button onclick="switchTab('history')" class="flex-1 py-3 text-center font-bold transition-all relative text-green-600">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-sm">履歴</span>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-green-600 rounded-t"></div>
                </button>
            `;
            
            document.getElementById('date-tabs').innerHTML = tabs;
            
            // キャンセルされた予約を除外
            const validHistory = history.filter(function(record) {
                return record.notes !== 'キャンセル';
            });
            
            let html = '<div class="mb-4 flex items-center justify-between">';
            html += '<h2 class="text-xl font-bold text-gray-800">清掃実施記録</h2>';
            html += '<select onchange="loadCleaningHistory(this.value)" class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-medium focus:border-green-500 focus:outline-none">';
            html += '<option value="7">過去7日間</option>';
            html += '<option value="30" selected>過去30日間</option>';
            html += '<option value="90">過去90日間</option>';
            html += '</select>';
            html += '</div>';
            
            if (validHistory.length === 0) {
                html += `
                    <div class="text-center py-16">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-gray-400 font-medium">清掃記録がありません</p>
                    </div>
                `;
            } else {
                html += '<div class="space-y-3">';
                
                let currentDate = '';
                validHistory.forEach(function(record) {
                    if (record.date !== currentDate) {
                        currentDate = record.date;
                        html += `
                            <div class="bg-gray-100 px-4 py-2 rounded-lg mt-4 first:mt-0">
                                <span class="text-sm font-bold text-gray-700">${record.dateDisplay}</span>
                            </div>
                        `;
                    }
                    
                    const duration = calculateDuration(record.startTime, record.endTime);
                    
                    html += `
                        <div class="bg-white border-2 border-gray-200 rounded-lg p-4 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="font-bold text-gray-900">メンテナンス完了</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 mb-2 text-gray-700">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="font-bold">${record.startTime} - ${record.endTime}</span>
                                <span class="text-sm">(${duration}分)</span>
                            </div>
                            <div class="text-xs text-gray-600">
                                担当: ${record.cleanerName}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            document.getElementById('content-area').innerHTML = html;
        }
        
        // ========================================
        // モーダル
        // ========================================
        function openBookingModal() {
            selectedBookingDate = 'today';
            const modal = document.getElementById('modal');
            modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-end justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-t-3xl w-full max-w-md animate-slide-up shadow-2xl">
                    <div class="h-2 bg-gradient-to-r from-green-500 to-green-600 rounded-t-3xl"></div>
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">メンテナンス予約</h3>
                                <p class="text-sm text-gray-500 mt-1">担当者: ${currentUser.name}</p>
                            </div>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-light">×</button>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">予約日</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button id="date-today" onclick="selectDate('today')" class="py-3 px-4 rounded-xl font-bold transition-all bg-green-600 text-white shadow-lg">本日</button>
                                    <button id="date-tomorrow" onclick="selectDate('tomorrow')" class="py-3 px-4 rounded-xl font-bold transition-all bg-gray-100 text-gray-600 hover:bg-gray-200">明日</button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">開始時刻</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <select id="start-hour" onchange="handleStartTimeChange()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none text-lg font-semibold">
                                        <option value="">時</option>
                                    </select>
                                    <select id="start-minute" onchange="handleStartTimeChange()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none text-lg font-semibold">
                                        <option value="">分</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">終了時刻</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <select id="end-hour" onchange="updateDuration()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none text-lg font-semibold">
                                        <option value="">時</option>
                                    </select>
                                    <select id="end-minute" onchange="updateDuration()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none text-lg font-semibold">
                                        <option value="">分</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="duration-display" class="hidden bg-green-50 border border-green-200 rounded-xl p-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-green-700 font-medium">所要時間</span>
                                    <span id="duration-text" class="text-lg font-bold text-green-800"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <button onclick="handleBooking()" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-xl font-bold hover:from-green-700 hover:to-green-800 transition-all shadow-lg">予約する</button>
                            <button onclick="closeModal()" class="w-full bg-gray-200 text-gray-700 py-4 rounded-xl font-bold hover:bg-gray-300 transition-all">キャンセル</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 時刻ドロップダウンを生成
            populateTimeOptions();
        }
        
        function openMaintenanceDetail(eventId) {
            const event = scheduleData.find(function(e) { return e.id === eventId; });
            if (!event) return;
            
            const modal = document.getElementById('modal');
            modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-end justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-t-3xl w-full max-w-md animate-slide-up shadow-2xl">
                    <div class="h-2 rounded-t-3xl bg-gradient-to-r from-purple-500 to-purple-600"></div>
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">メンテナンス予約詳細</h3>
                            </div>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-light">×</button>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between items-center py-3 border-b border-gray-200">
                                <span class="text-gray-600 font-medium">メンテナンス時間</span>
                                <span class="font-bold text-gray-800">${event.startTime} - ${event.endTime}</span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-gray-200">
                                <span class="text-gray-600 font-medium">担当者</span>
                                <span class="font-bold text-gray-800">${event.cleanerName || '未設定'}</span>
                            </div>
                            ${event.notes ? `
                            <div class="py-3 border-b border-gray-200">
                                <span class="text-gray-600 font-medium block mb-2">備考</span>
                                <span class="text-gray-800">${event.notes}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="space-y-3">
                            <button onclick="confirmCancel('${eventId}')" class="w-full bg-red-500 text-white py-4 rounded-xl font-bold hover:bg-red-600 transition-all">
                                予約をキャンセル
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function closeModal() {
            document.getElementById('modal').className = 'hidden';
            document.getElementById('modal').innerHTML = '';
        }
        
        // ========================================
        // ヘルパー関数
        // ========================================
        function populateTimeOptions() {
            const startHourSelect = document.getElementById('start-hour');
            const startMinuteSelect = document.getElementById('start-minute');
            const endHourSelect = document.getElementById('end-hour');
            const endMinuteSelect = document.getElementById('end-minute');
            
            // 時間のオプションを生成（06:00〜24:00）
            for (let hour = 6; hour <= 24; hour++) {
                const hourValue = String(hour).padStart(2, '0');
                
                const startHourOption = document.createElement('option');
                startHourOption.value = hourValue;
                startHourOption.textContent = hourValue + '時';
                startHourSelect.appendChild(startHourOption);
                
                const endHourOption = document.createElement('option');
                endHourOption.value = hourValue;
                endHourOption.textContent = hourValue + '時';
                endHourSelect.appendChild(endHourOption);
            }
            
            // 分のオプションを生成（00, 15, 30, 45）
            const minutes = ['00', '15', '30', '45'];
            minutes.forEach(function(minute) {
                const startMinuteOption = document.createElement('option');
                startMinuteOption.value = minute;
                startMinuteOption.textContent = minute + '分';
                startMinuteSelect.appendChild(startMinuteOption);
                
                const endMinuteOption = document.createElement('option');
                endMinuteOption.value = minute;
                endMinuteOption.textContent = minute + '分';
                endMinuteSelect.appendChild(endMinuteOption);
            });
        }
        
        function selectDate(date) {
            selectedBookingDate = date;
            document.getElementById('date-today').className = date === 'today' 
                ? 'py-3 px-4 rounded-xl font-bold transition-all bg-green-600 text-white shadow-lg'
                : 'py-3 px-4 rounded-xl font-bold transition-all bg-gray-100 text-gray-600 hover:bg-gray-200';
            document.getElementById('date-tomorrow').className = date === 'tomorrow'
                ? 'py-3 px-4 rounded-xl font-bold transition-all bg-green-600 text-white shadow-lg'
                : 'py-3 px-4 rounded-xl font-bold transition-all bg-gray-100 text-gray-600 hover:bg-gray-200';
        }
        
        function handleStartTimeChange() {
            const startHour = document.getElementById('start-hour').value;
            const startMinute = document.getElementById('start-minute').value;
            
            if (!startHour || !startMinute) return;
            
            let hours = parseInt(startHour);
            let minutes = parseInt(startMinute);
            let endHour = hours;
            let endMin = minutes + 30;
            
            if (endMin >= 60) {
                endHour += 1;
                endMin -= 60;
            }
            
            // 24:00を超える場合は24:00に設定
            if (endHour > 24 || (endHour === 24 && endMin > 0)) {
                endHour = 24;
                endMin = 0;
            }
            
            document.getElementById('end-hour').value = String(endHour).padStart(2, '0');
            document.getElementById('end-minute').value = String(endMin).padStart(2, '0');
            updateDuration();
        }
        
        function updateDuration() {
            const startHour = document.getElementById('start-hour').value;
            const startMinute = document.getElementById('start-minute').value;
            const endHour = document.getElementById('end-hour').value;
            const endMinute = document.getElementById('end-minute').value;
            
            if (startHour && startMinute && endHour && endMinute) {
                const startTime = startHour + ':' + startMinute;
                const endTime = endHour + ':' + endMinute;
                const duration = calculateDuration(startTime, endTime);
                document.getElementById('duration-display').className = 'bg-green-50 border border-green-200 rounded-xl p-3';
                document.getElementById('duration-text').textContent = duration + '分';
            }
        }
        
        function handleBooking() {
            const startHour = document.getElementById('start-hour').value;
            const startMinute = document.getElementById('start-minute').value;
            const endHour = document.getElementById('end-hour').value;
            const endMinute = document.getElementById('end-minute').value;
            
            if (!startHour || !startMinute || !endHour || !endMinute) {
                alert('開始時刻と終了時刻を入力してください');
                return;
            }
            
            const startTime = startHour + ':' + startMinute;
            const endTime = endHour + ':' + endMinute;
            
            const duration = calculateDuration(startTime, endTime);
            if (duration <= 0) {
                alert('終了時刻は開始時刻より後にしてください');
                return;
            }
            
            createMaintenance(selectedBookingDate, startTime, endTime);
        }
        
        function confirmCancel(eventId) {
            if (confirm('本当にキャンセルしますか？')) {
                cancelMaintenance(eventId);
            }
        }
        
        function switchTab(tab) {
            if (tab === 'history') {
                currentDate = 'history';
                loadCleaningHistory(30);
            } else {
                loadSchedule(tab);
            }
        }
        
        function calculateDuration(start, end) {
            const startParts = start.split(':');
            const endParts = end.split(':');
            const startHour = parseInt(startParts[0]);
            const startMin = parseInt(startParts[1]);
            const endHour = parseInt(endParts[0]);
            const endMin = parseInt(endParts[1]);
            return (endHour * 60 + endMin) - (startHour * 60 + startMin);
        }
        
        function getTodayText() {
            const today = new Date();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            return month + '/' + day;
        }
        
        function getTomorrowText() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const month = tomorrow.getMonth() + 1;
            const day = tomorrow.getDate();
            return month + '/' + day;
        }
        
        function showLoading() {
            const content = document.getElementById('content-area');
            if (content) {
                content.innerHTML = `
                    <div class="text-center py-8">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-gray-600">処理中...</p>
                    </div>
                `;
            }
        }
        
        function showError(message) {
            alert(message);
            if (currentDate === 'history') {
                loadCleaningHistory(30);
            } else {
                loadSchedule(currentDate);
            }
        }
        
        // ========================================
        // アプリ起動
        // ========================================
        window.onload = function() {
            init();
        };
    </script>
</body>
</html>
